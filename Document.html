<!DOCTYPE html>
<html>
<head>
    <title>Document</title>
    <link rel="stylesheet" href="./Doc/Document.css" />
    <link rel="stylesheet" href="./Doc/TreeView.css" />
    <script src="./Script/Package.js"></script>
    <script src="./Script/Class.js"></script>
    <script src="./Script/Test.js"></script>
    <script src="./Script/Html/Navigation.js"></script>
    <script src="./Script/Html/Razor.js"></script>
    <script src="./Doc/TreeView.js"></script>
    <script src="./Doc/Delay.js"></script>
    <script src="./Doc/Resource.js"></script>
    <script src="./Doc/Document.js"></script>
</head>
<body>
    <script>
        eval(Packages.Inject(["Test"]));
    </script>
    <!-- Task.js -->
    <script>
        TestCase("writing a result to a not evaluated delay should success", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            var x = CreateDelay();
            x.promise.SetResult(100);
            Assert(x.future.Result === 100);
        })
    </script>
    <script>
        TestCase("writing a result to an evaluated delay should success", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            var x = CreateDelay();
            x.promise.SetResult(100);
            try {
                x.promise.SetResult(200);
                Assert(false);
            }
            catch (ex) {
                Assert(x.future.Result === 100);
            }
        })
    </script>
    <script>
        TestCase("a written succeeded result should be correctly redirected", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            var x = CreateDelay();
            var f1 = x.future.SucceededThen(function (value) {
                return value * 2;
            });
            var f2 = x.future.Then(function (value) {
                Assert(!DelayException.TestType(value));
                return value * 4;
            });
            x.promise.SetResult(100);
            Assert(f1.Result === 200);
            Assert(f2.Result === 400);
        })
    </script>
    <script>
        TestCase("a written failed result should be correctly redirected", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            var x = CreateDelay();
            var f1 = x.future.FailedThen(function (value) {
                return value * 2;
            });
            var f2 = x.future.Then(function (value) {
                Assert(DelayException.TestType(value));
                return value.Exception * 4;
            });
            x.promise.SetException(100);
            Assert(f1.Result === 200);
            Assert(f2.Result === 400);
        })
    </script>
    <script>
        TestCase("exception should be converted to failed result (1)", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            var x = CreateDelay();
            var f1 = x.future.SucceededThen(function (value) {
                throw value * 2;
            });
            var f2 = x.future.Then(function (value) {
                throw value * 4;
            });
            x.promise.SetResult(100);
            Assert(f1.Result.Exception === 200);
            Assert(f2.Result.Exception === 400);
        })
    </script>
    <script>
        TestCase("exception should be converted to failed result (2)", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            var x = CreateDelay();
            var f1 = x.future.FailedThen(function (value) {
                throw value * 2;
            });
            var f2 = x.future.Then(function (value) {
                throw value.Exception * 4;
            });
            x.promise.SetException(100);
            Assert(f1.Result.Exception === 200);
            Assert(f2.Result.Exception === 400);
        })
    </script>
    <script>
        TestCase("wait all should success", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            for (var i = 0; i <= 3; i++) {
                var ds = [CreateDelay(), CreateDelay(), CreateDelay()];
                for (var j = 0; j < i; j++) {
                    ds[j].promise.SetResult(j);
                }

                var f = WaitAll(ds.map(function (delay) { return delay.future; }));
                Assert(f.HasResult() === (i === 3));

                for (var j = i; j < 3; j++) {
                    ds[j].promise.SetResult(j);
                }
                Assert(f.HasResult() === true);

                Assert(f.Result.length === 3);
                for (var j = 0; j < 3; j++) {
                    Assert(f.Result[j] === j);
                }
            }
        })
    </script>
    <script>
        TestCase("wait any should success", function () {
            eval(Packages.Inject(["Doc.Delay"]));

            for (var i = 0; i < 3; i++) {
                {
                    var ds = [CreateDelay(), CreateDelay(), CreateDelay()];
                    ds[i].promise.SetResult(i);

                    var f = WaitAny(ds.map(function (delay) { return delay.future; }));
                    Assert(f.HasResult() === true);

                    Assert(f.Result.index === i);
                    Assert(f.Result.result === i);
                }
                {
                    var ds = [CreateDelay(), CreateDelay(), CreateDelay()];

                    var f = WaitAny(ds.map(function (delay) { return delay.future; }));
                    Assert(f.HasResult() === false);

                    ds[i].promise.SetResult(i);
                    Assert(f.HasResult() === true);

                    Assert(f.Result.index === i);
                    Assert(f.Result.result === i);
                }
            }
        })
    </script>
    <!-- Summary -->
    <script>
        SummaryTest();
    </script>
</body>
</html>
