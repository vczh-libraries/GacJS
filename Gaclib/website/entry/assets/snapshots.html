<!DOCTYPE html>
<html>

<head>
    <title>GacUI Snapshot Viewer</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./global.css" />
    <link rel="stylesheet" type="text/css" href="./snapshots.css" />
    <script src="/index.js"></script>
</head>

<body>
    <div class="container">
        <div class="files-column" id="filesColumn">
            <h3>Files Tree View</h3>
            <div id="filesTreeView"></div>
        </div>
        <div class="splitter" id="filesSplitter"></div>
        <div class="frames-column" id="framesColumn">
            <h3>Frame List</h3>
            <div id="frameList">Click on a file to show frame names.</div>
        </div>
        <div class="splitter" id="framesSplitter"></div>
        <div class="rendering-column" id="renderingColumn">
            Click on a frame to show the UI.
        </div>
    </div>

    <script lang="javascript">
        function renderFrame(frame) {
            document.getElementById('renderingColumn').textContent = JSON.stringify(frame, null, 2);
        }

        async function renderSnapshot(url) {
            try {
                // Fetch the JSON file
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const trace = await response.json();
                
                // Clear the existing frames list
                const frameList = document.getElementById('frameList');
                frameList.innerHTML = '';
                
                // Create tree element for frames
                const framesTree = GacUIHtmlRenderer.readFrames(trace);
                const frameTreeElement = GacUIHtmlRenderer.createTreeElement(framesTree, {
                    onSelected: renderFrame
                });
                frameList.appendChild(frameTreeElement);
                
            } catch (error) {
                document.getElementById('frameList').textContent = `Error loading frames: ${error.message}`;
            }
        }

        // Initialize the tree view
        function initializeTreeView() {
            const filesTreeView = document.getElementById('filesTreeView');
            const treeElement = GacUIHtmlRenderer.createTreeElement(GacUIHtmlRenderer.readSnapshot(GacUIHtmlRenderer.Snapshot, './snapshots/'), {
                onSelected: renderSnapshot
            });
            filesTreeView.appendChild(treeElement);
        }

        // Initialize splitter functionality
        function initializeSplitter() {
            const filesSplitter = document.getElementById('filesSplitter');
            const framesSplitter = document.getElementById('framesSplitter');
            const filesColumn = document.getElementById('filesColumn');
            const framesColumn = document.getElementById('framesColumn');
            const container = document.querySelector('.container');

            let isResizing = false;
            let currentSplitter = null;

            function startResize(splitter, e) {
                isResizing = true;
                currentSplitter = splitter;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            }

            filesSplitter.addEventListener('mousedown', (e) => {
                startResize('filesSplitter', e);
            });

            framesSplitter.addEventListener('mousedown', (e) => {
                startResize('framesSplitter', e);
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const newX = e.clientX - containerRect.left;

                if (currentSplitter === 'filesSplitter') {
                    // Files splitter: controls files column width
                    // Constrain width between 200px and 60% of container width
                    const minWidth = 200;
                    const maxWidth = containerRect.width * 0.6;
                    const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newX));

                    filesColumn.style.width = constrainedWidth + 'px';
                } else if (currentSplitter === 'framesSplitter') {
                    // Frames splitter: controls frames column width
                    // Calculate available space (total width - files column width - splitter widths)
                    const filesWidth = filesColumn.offsetWidth;
                    const splitterWidth = 6; // Each splitter is 6px wide
                    const availableStart = filesWidth + splitterWidth;
                    const availableWidth = containerRect.width - availableStart - splitterWidth;

                    const framesWidth = newX - availableStart;

                    // Constrain frames column width
                    const minFramesWidth = 200;
                    const maxFramesWidth = Math.max(minFramesWidth, availableWidth * 0.8);
                    const constrainedFramesWidth = Math.max(minFramesWidth, Math.min(maxFramesWidth, framesWidth));

                    framesColumn.style.width = constrainedFramesWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentSplitter = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTreeView();
            initializeSplitter();
        });

        // If DOMContentLoaded has already fired, initialize immediately
        if (document.readyState === 'loading') {
            // Do nothing, event listener above will handle it
        } else {
            initializeTreeView();
            initializeSplitter();
        }
    </script>
</body>

</html>