<!DOCTYPE html>
<html>

<head>
    <title>GacUI Snapshot Viewer</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./global.css" />
    <link rel="stylesheet" type="text/css" href="./snapshots.css" />
    <script src="/index.js"></script>
</head>

<body>
    <div class="container">
        <div class="files-column" id="filesColumn">
            <div id="treeView"></div>
        </div>
        <div class="splitter" id="filesSplitter"></div>
        <div class="frames-column" id="framesColumn">
            Click on a file to show frame names.
        </div>
        <div class="splitter" id="framesSplitter"></div>
        <div class="rendering-column" id="renderingColumn">
            Click on a frame to show the UI.
        </div>
    </div>

    <script lang="javascript">
        const Snapshot = GacUIHtmlRenderer.Snapshot;
        let currentSelectedFile = null; // Track currently selected file

        function renderSnapshot(url) {
            document.getElementById('renderingColumn').textContent = url;
        }

        // Function to create tree element from a data structure
        function createTreeElement(tree /*: TreeFolder*/, indent = 0) {
            /*
            interface TreeFolder {
                type: 'Folder';
                content: { [name: string]: TreeNode };
            }

            interface TreeFile {
                type: 'File';
                display: string;
                url: string;
            }

            type TreeNode = TreeFolder | TreeFile;
            */
            const container = document.createElement('div');

            // Sort entries: folders first, then files, both alphabetically
            const entries = Object.entries(tree.content);
            const folders = entries.filter(([, value]) => value.type === 'Folder').sort(([a], [b]) => a.localeCompare(b));
            const files = entries.filter(([, value]) => value.type === 'File').sort(([a], [b]) => a.localeCompare(b));

            // Add folders first
            folders.forEach(([name, childEntry]) => {
                // Create folder element
                const folderDiv = document.createElement('div');
                folderDiv.className = 'tree-item tree-folder';

                const indentSpan = document.createElement('span');
                indentSpan.className = 'tree-indent';
                indentSpan.style.width = (indent * 4) + 'ch';
                folderDiv.appendChild(indentSpan);

                folderDiv.appendChild(document.createTextNode(name));
                container.appendChild(folderDiv);

                // Recursively add folder content
                container.appendChild(createTreeElement(childEntry, indent + 1));
            });

            // Add files
            files.forEach(([name, fileEntry]) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'tree-item';

                const indentSpan = document.createElement('span');
                indentSpan.className = 'tree-indent';
                indentSpan.style.width = (indent * 4) + 'ch';
                fileDiv.appendChild(indentSpan);

                const fileLink = document.createElement('a');
                fileLink.className = 'tree-file';
                fileLink.href = '#';
                fileLink.textContent = fileEntry.display;

                fileLink.addEventListener('click', (e) => {
                    e.preventDefault();

                    // Remove selected class from previously selected file
                    if (currentSelectedFile) {
                        currentSelectedFile.classList.remove('selected');
                    }

                    // Add selected class to current file
                    fileLink.classList.add('selected');
                    currentSelectedFile = fileLink;

                    renderSnapshot(fileEntry.url);
                });

                fileDiv.appendChild(fileLink);
                container.appendChild(fileDiv);
            });

            return container;
        }

        // Function to read snapshot and convert to tree structure
        function readSnapshot(entry, path = '') {
            if (entry.type === 'Folder') {
                const treeFolder = {
                    type: 'Folder',
                    content: {}
                };

                Object.entries(entry.content).forEach(([name, childEntry]) => {
                    const childPath = path ? `${path}/${name}` : name;
                    treeFolder.content[name] = readSnapshot(childEntry, childPath);
                });

                return treeFolder;
            } else {
                // entry === 'File'
                const filePath = path ? `./${path}` : `./${path}`;
                return {
                    type: 'File',
                    display: path.split('/').pop() || 'Unknown',
                    url: filePath
                };
            }
        }

        // Initialize the tree view
        function initializeTreeView() {
            const treeView = document.getElementById('treeView');
            const treeData = readSnapshot(Snapshot);
            const treeElement = createTreeElement(treeData);
            treeView.appendChild(treeElement);
        }

        // Initialize splitter functionality
        function initializeSplitter() {
            const filesSplitter = document.getElementById('filesSplitter');
            const framesSplitter = document.getElementById('framesSplitter');
            const filesColumn = document.getElementById('filesColumn');
            const framesColumn = document.getElementById('framesColumn');
            const container = document.querySelector('.container');

            let isResizing = false;
            let currentSplitter = null;

            function startResize(splitter, e) {
                isResizing = true;
                currentSplitter = splitter;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            }

            filesSplitter.addEventListener('mousedown', (e) => {
                startResize('filesSplitter', e);
            });

            framesSplitter.addEventListener('mousedown', (e) => {
                startResize('framesSplitter', e);
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const newX = e.clientX - containerRect.left;

                if (currentSplitter === 'filesSplitter') {
                    // Files splitter: controls files column width
                    // Constrain width between 200px and 60% of container width
                    const minWidth = 200;
                    const maxWidth = containerRect.width * 0.6;
                    const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newX));

                    filesColumn.style.width = constrainedWidth + 'px';
                } else if (currentSplitter === 'framesSplitter') {
                    // Frames splitter: controls frames column width
                    // Calculate available space (total width - files column width - splitter widths)
                    const filesWidth = filesColumn.offsetWidth;
                    const splitterWidth = 6; // Each splitter is 6px wide
                    const availableStart = filesWidth + splitterWidth;
                    const availableWidth = containerRect.width - availableStart - splitterWidth;

                    const framesWidth = newX - availableStart;

                    // Constrain frames column width
                    const minFramesWidth = 200;
                    const maxFramesWidth = Math.max(minFramesWidth, availableWidth * 0.8);
                    const constrainedFramesWidth = Math.max(minFramesWidth, Math.min(maxFramesWidth, framesWidth));

                    framesColumn.style.width = constrainedFramesWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentSplitter = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTreeView();
            initializeSplitter();
        });

        // If DOMContentLoaded has already fired, initialize immediately
        if (document.readyState === 'loading') {
            // Do nothing, event listener above will handle it
        } else {
            initializeTreeView();
            initializeSplitter();
        }
    </script>
</body>

</html>