<!DOCTYPE html>
<html>

<head>
    <title>GacUI Snapshot Viewer</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./global.css" />
    <link rel="stylesheet" type="text/css" href="./snapshots.css" />
    <script src="/index.js"></script>
</head>

<body>
    <div class="container">
        <div class="left-column" id="leftColumn">
            <div id="treeView"></div>
        </div>
        <div class="splitter" id="splitter1"></div>
        <div class="middle-column" id="middleColumn">
            Click on a file to show frame names.
        </div>
        <div class="splitter" id="splitter2"></div>
        <div class="right-column" id="rightColumn">
            Click on a frame to show the UI.
        </div>
    </div>

    <script lang="javascript">
        const Snapshot = GacUIHtmlRenderer.Snapshot;
        let currentSelectedFile = null; // Track currently selected file

        function renderSnapshot(url) {
            document.getElementById('rightColumn').textContent = url;
        }

        // Function to create tree structure recursively
        function createTreeElement(entry, path = '', indent = 0) {
            const container = document.createElement('div');

            if (entry.type === 'Folder') {
                // Create folder element
                const folderDiv = document.createElement('div');
                folderDiv.className = 'tree-item tree-folder';

                const indentSpan = document.createElement('span');
                indentSpan.className = 'tree-indent';
                indentSpan.style.width = (indent * 4) + 'ch';
                folderDiv.appendChild(indentSpan);

                const folderName = path.split('/').pop() || 'Application';
                folderDiv.appendChild(document.createTextNode(folderName));
                container.appendChild(folderDiv);

                // Sort entries: folders first, then files, both alphabetically
                const entries = Object.entries(entry.content);
                const folders = entries.filter(([, value]) => value.type === 'Folder').sort(([a], [b]) => a.localeCompare(b));
                const files = entries.filter(([, value]) => value === 'File').sort(([a], [b]) => a.localeCompare(b));

                // Add folders first
                folders.forEach(([name, childEntry]) => {
                    const childPath = path ? `${path}/${name}` : name;
                    container.appendChild(createTreeElement(childEntry, childPath, indent + 1));
                });

                // Add files
                files.forEach(([name]) => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'tree-item';

                    const indentSpan = document.createElement('span');
                    indentSpan.className = 'tree-indent';
                    indentSpan.style.width = ((indent + 1) * 4) + 'ch';
                    fileDiv.appendChild(indentSpan);

                    const fileLink = document.createElement('a');
                    fileLink.className = 'tree-file';
                    fileLink.href = '#';
                    fileLink.textContent = name;

                    const filePath = path ? `./${path}/${name}` : `./${name}`;
                    fileLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // Remove selected class from previously selected file
                        if (currentSelectedFile) {
                            currentSelectedFile.classList.remove('selected');
                        }
                        
                        // Add selected class to current file
                        fileLink.classList.add('selected');
                        currentSelectedFile = fileLink;
                        
                        renderSnapshot(filePath);
                    });

                    fileDiv.appendChild(fileLink);
                    container.appendChild(fileDiv);
                });
            }

            return container;
        }

        // Initialize the tree view
        function initializeTreeView() {
            const treeView = document.getElementById('treeView');
            const treeElement = createTreeElement(Snapshot);
            treeView.appendChild(treeElement);
        }

        // Initialize splitter functionality
        function initializeSplitter() {
            const splitter1 = document.getElementById('splitter1');
            const splitter2 = document.getElementById('splitter2');
            const leftColumn = document.getElementById('leftColumn');
            const middleColumn = document.getElementById('middleColumn');
            const container = document.querySelector('.container');

            let isResizing = false;
            let currentSplitter = null;

            function startResize(splitter, e) {
                isResizing = true;
                currentSplitter = splitter;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            }

            splitter1.addEventListener('mousedown', (e) => {
                startResize('splitter1', e);
            });

            splitter2.addEventListener('mousedown', (e) => {
                startResize('splitter2', e);
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerRect = container.getBoundingClientRect();
                const newX = e.clientX - containerRect.left;

                if (currentSplitter === 'splitter1') {
                    // First splitter: controls left column width
                    // Constrain width between 200px and 60% of container width
                    const minWidth = 200;
                    const maxWidth = containerRect.width * 0.6;
                    const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newX));

                    leftColumn.style.width = constrainedWidth + 'px';
                } else if (currentSplitter === 'splitter2') {
                    // Second splitter: controls middle column width
                    // Calculate available space (total width - left column width - splitter widths)
                    const leftWidth = leftColumn.offsetWidth;
                    const splitterWidth = 6; // Each splitter is 6px wide
                    const availableStart = leftWidth + splitterWidth;
                    const availableWidth = containerRect.width - availableStart - splitterWidth;
                    
                    const middleWidth = newX - availableStart;
                    
                    // Constrain middle column width
                    const minMiddleWidth = 200;
                    const maxMiddleWidth = Math.max(minMiddleWidth, availableWidth * 0.8);
                    const constrainedMiddleWidth = Math.max(minMiddleWidth, Math.min(maxMiddleWidth, middleWidth));

                    middleColumn.style.width = constrainedMiddleWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentSplitter = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTreeView();
            initializeSplitter();
        });

        // If DOMContentLoaded has already fired, initialize immediately
        if (document.readyState === 'loading') {
            // Do nothing, event listener above will handle it
        } else {
            initializeTreeView();
            initializeSplitter();
        }
    </script>
</body>

</html>